<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/aa.png">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>지문자 마스터</title>
    <style>
        :root {
            --bg-color: #000000;
            --card-color: #1C1C1E;
            --text-color: #E5E5E7;
            --accent-color: #0A84FF;
            --danger-color: #FF453A;
            --success-color: #32D74B;
        }
        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: env(safe-area-inset-top) 15px 20px 15px;
            height: 100dvh; overflow: hidden; box-sizing: border-box;
        }
        
        /* 뷰 컨트롤 (메인 vs 기록 화면 전환용) */
        .view { display: none; width: 100%; height: 100%; flex-direction: column; gap: 10px; }
        .view.active { display: flex; }

        /* --- 메인 화면 스타일 --- */
        .control-row { display: flex; justify-content: space-between; gap: 8px; }
        .control-group {
            display: flex; align-items: center; gap: 5px; flex: 1;
            background-color: var(--card-color); padding: 6px 10px;
            border-radius: 10px; font-size: 13px;
        }
        .control-group label { font-weight: 600; white-space: nowrap; }
        input[type="range"] { flex-grow: 1; height: 4px; }
        select {
            flex-grow: 1; padding: 6px; border-radius: 6px; border: none;
            background-color: #2C2C2E; color: white; font-size: 13px;
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 8px center;
        }
        
        /* 버튼 3개 동일 크기 배치 */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        button {
            background-color: var(--card-color); color: var(--accent-color);
            border: none; border-radius: 10px; padding: 12px 5px;
            font-size: 14px; font-weight: bold; cursor: pointer; text-align: center;
        }
        button.primary { background-color: var(--accent-color); color: white; }
        button:active { opacity: 0.7; }
        
        .card {
            background-color: var(--card-color); border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            flex-grow: 1; justify-content: space-between; overflow: hidden;
        }
        
        .image-wrapper {
            width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center;
            background-color: #000; border-radius: 12px; overflow: hidden; position: relative;
        }
        #mainImage { width: 100%; height: 100%; object-fit: contain; display: none; }
        #placeholderText { position: absolute; width: 100%; text-align: center; font-size: 24px; color: #8E8E93; font-weight: bold; }
        .large-text { font-size: 120px !important; color: white !important; }

        .input-group { display: flex; width: 100%; gap: 8px; margin-top: auto; }
        input[type="text"] {
            flex-grow: 1; padding: 12px; border-radius: 10px; border: none;
            background-color: #2C2C2E; color: white; font-size: 17px;
        }
        input[type="text"]:focus { outline: 2px solid var(--accent-color); }
        #feedback { font-size: 17px; font-weight: bold; height: 24px; text-align: center; }

        /* --- 기록 화면 스타일 --- */
        .history-header {
            display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #3E3E42;
        }
        .history-header button {
            background: none; border: none; color: var(--accent-color); font-size: 16px; padding: 5px 15px 5px 0; text-align: left;
        }
        .history-header h2 { margin: 0; flex-grow: 1; text-align: center; font-size: 18px; padding-right: 40px; }
        
        .history-list {
            list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1;
        }
        .history-item {
            background-color: var(--card-color); margin-bottom: 8px; border-radius: 10px;
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            cursor: pointer;
        }
        .history-item:active { opacity: 0.7; }
        .history-word { font-size: 18px; font-weight: bold; }
        .history-status { font-size: 14px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }
        .status-correct { background-color: rgba(50, 215, 75, 0.2); color: var(--success-color); }
        .status-wrong { background-color: rgba(255, 69, 58, 0.2); color: var(--danger-color); }
    </style>
</head>
<body>

<div id="mainView" class="view active">
    <div class="control-row">
        <div class="control-group" style="flex: 1.2;">
            <label>속도</label>
            <input type="range" id="speedSlider" min="200" max="1500" value="500" step="50">
            <span id="speedVal" style="font-size: 12px; min-width: 40px; text-align: right;">500ms</span>
        </div>
        <div class="control-group">
            <select id="lengthSelect">
                <option value="2-3">2~3글자(랜덤)</option>
                <option value="3-4">3~4글자</option>
                <option value="5+">5글자 이상</option>
            </select>
        </div>
    </div>

    <div class="btn-group">
        <button class="primary" onclick="startNewWord()">새 단어</button>
        <button id="playPauseBtn" onclick="togglePlayPause()">일시정지</button>
        <button onclick="showHistoryView()">기록</button>
    </div>

    <div class="card">
        <div class="image-wrapper" id="imageWrapper">
            <img id="mainImage" alt="수어 이미지">
            <span id="placeholderText">시작 버튼을<br>눌러주세요</span>
        </div>
        
        <div id="feedback"></div>

        <div class="input-group">
            <input type="text" id="answerInput" placeholder="정답 입력" autocomplete="off" enterkeyhint="done">
            <button class="primary" onclick="checkAnswer()" style="padding: 0 20px;">확인</button>
        </div>
    </div>
</div>

<div id="historyView" class="view">
    <div class="history-header">
        <button onclick="hideHistoryView()">❮ 뒤로</button>
        <h2>학습 기록</h2>
    </div>
    <ul class="history-list" id="historyList">
        </ul>
</div>

<script>
    let currentWord = "";
    let jamoList = [];
    let cachedFrames = []; // 미리 불러온 이미지/텍스트 데이터를 저장할 배열
    let currentIdx = 0;
    let timer = null;
    let isPaused = false;
    let isFinished = false; // 재생이 끝났는지 여부
    let historyData = JSON.parse(localStorage.getItem('fingerspell_history')) || [];

    const fallbackWords = {
        '2-3': ["사과","포도","학교","바다","하늘","우주","의자","연필","가방","신발","사진","구름","가족","친구","사랑","운동","수영","기차","버스","경찰","병원","식당","동물","피아노"],
        '3-4': ["컴퓨터","자전거","도서관","박물관","경찰서","소방서","선생님","카메라","냉장고","세탁기","자동차","지하철","신호등","놀이터","우체국","편의점","대학교","운동장","수영장","미술관"],
        '5+': ["대한민국","아이스크림","텔레비전","엘리베이터","에스컬레이터","스마트폰","동물원","식물원","과학관","주민센터","보건소"]
    };

    const CHOSUNG = ['ㄱ','ㄲ','ㄴ','ㄷ','ㄸ','ㄹ','ㅁ','ㅂ','ㅃ','ㅅ','ㅆ','ㅇ','ㅈ','ㅉ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
    const JUNGSUNG = ['ㅏ','ㅐ','ㅑ','ㅒ','ㅓ','ㅔ','ㅕ','ㅖ','ㅗ','ㅘ','ㅙ','ㅚ','ㅛ','ㅜ','ㅝ','ㅞ','ㅟ','ㅠ','ㅡ','ㅢ','ㅣ'];
    const JONGSUNG = ['','ㄱ','ㄲ','ㄳ','ㄴ','ㄵ','ㄶ','ㄷ','ㄹ','ㄺ','ㄻ','ㄼ','ㄽ','ㄾ','ㄿ','ㅀ','ㅁ','ㅂ','ㅄ','ㅅ','ㅆ','ㅇ','ㅈ','ㅊ','ㅋ','ㅌ','ㅍ','ㅎ'];
    const COMPOUND = {'ㄳ':['ㄱ','ㅅ'],'ㄵ':['ㄴ','ㅈ'],'ㄶ':['ㄴ','ㅎ'],'ㄺ':['ㄹ','ㄱ'],'ㄻ':['ㄹ','ㅁ'],'ㄼ':['ㄹ','ㅂ'],'ㄽ':['ㄹ','ㅅ'],'ㄾ':['ㄹ','ㅌ'],'ㄿ':['ㄹ','ㅍ'],'ㅀ':['ㄹ','ㅎ'],'ㅄ':['ㅂ','ㅅ'],'ㅘ':['ㅗ','ㅏ'],'ㅙ':['ㅗ','ㅐ'],'ㅝ':['ㅜ','ㅓ'],'ㅞ':['ㅜ','ㅔ'],'ㄲ':['ㄱ','ㄱ'],'ㄸ':['ㄷ','ㄷ'],'ㅃ':['ㅂ','ㅂ'],'ㅆ':['ㅅ','ㅅ'],'ㅉ':['ㅈ','ㅈ']};

    function splitHangul(word) {
        let result = [];
        for (let i = 0; i < word.length; i++) {
            let code = word.charCodeAt(i) - 44032;
            if (code >= 0 && code <= 11171) {
                let cho = Math.floor(code / 588);
                let jung = Math.floor((code % 588) / 28);
                let jong = code % 28;
                [CHOSUNG[cho], JUNGSUNG[jung], JONGSUNG[jong]].forEach(unit => {
                    if (unit && COMPOUND[unit]) result.push(...COMPOUND[unit]);
                    else if (unit) result.push(unit);
                });
            }
        }
        return result;
    }

    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    speedSlider.addEventListener('input', (e) => speedVal.innerText = e.target.value + 'ms');
    document.getElementById('answerInput').addEventListener('keypress', (e) => { if(e.key==='Enter') checkAnswer(); });

    async function fetchWord() {
        const selectedRange = document.getElementById('lengthSelect').value;
        let targetList = fallbackWords[selectedRange]; 

        try {
            const response = await fetch('/api/word');
            if (!response.ok) throw new Error("서버 오류");
            const textData = await response.text();
            if (textData.includes("<error>")) throw new Error("API 오류");

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(textData, "text/xml");
            const items = Array.from(xmlDoc.getElementsByTagName("item"));

            let candidates = items.map(item => item.getElementsByTagName("word")[0].textContent.replace(/[^가-힣]/g, ''));
            if (selectedRange === '2-3') candidates = candidates.filter(w => w.length >= 2 && w.length <= 3);
            else if (selectedRange === '3-4') candidates = candidates.filter(w => w.length >= 3 && w.length <= 4);
            else if (selectedRange === '5+') candidates = candidates.filter(w => w.length >= 5);

            if (candidates.length > 0) return candidates[Math.floor(Math.random() * candidates.length)];
            throw new Error("조건에 맞는 단어 없음");
        } catch (error) {
            return targetList[Math.floor(Math.random() * targetList.length)];
        }
    }

    // ★ 모든 이미지를 100% 로드한 뒤에 배열로 반환하는 함수
    function preloadAllImages(jamoArray) {
        return Promise.all(jamoArray.map(char => {
            return new Promise(resolve => {
                const img = new Image();
                img.src = `images/${char}.png`;
                img.onload = () => resolve({ type: 'image', src: img.src, char: char });
                img.onerror = () => resolve({ type: 'text', char: char });
            });
        }));
    }

    async function startNewWord() {
        if(timer) clearInterval(timer);
        resetUIForLoading("단어 찾는 중...");
        
        currentWord = await fetchWord();
        jamoList = splitHangul(currentWord);
        
        document.getElementById('placeholderText').innerHTML = "이미지<br>불러오는 중...";
        
        // ★ 백그라운드에서 모든 프레임을 캐싱할 때까지 대기
        cachedFrames = await preloadAllImages(jamoList);
        
        playFromStart();
    }

    function playFromStart() {
        if(timer) clearInterval(timer);
        currentIdx = 0;
        isPaused = false;
        isFinished = false;
        
        updatePlayButtonUI();
        
        // 첫 프레임 즉시 보여주고, 타이머 시작 (정확한 간격 유지)
        renderFrame();
        timer = setInterval(renderFrame, speedSlider.value);
    }

    // 박자에 맞춰 화면에 프레임을 그리는 순수 렌더링 함수
    function renderFrame() {
        if (isPaused || isFinished) return;

        const mainImage = document.getElementById('mainImage');
        const placeholder = document.getElementById('placeholderText');

        if (currentIdx < cachedFrames.length) {
            const frame = cachedFrames[currentIdx];
            if (frame.type === 'image') {
                mainImage.src = frame.src;
                mainImage.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                mainImage.style.display = 'none';
                placeholder.innerText = frame.char;
                placeholder.classList.add('large-text');
                placeholder.style.display = 'block';
            }
            currentIdx++;
        } else {
            // 재생 완료
            clearInterval(timer);
            isFinished = true;
            updatePlayButtonUI();
            
            mainImage.style.display = 'none';
            placeholder.innerHTML = "입력 대기 중";
            placeholder.classList.remove('large-text');
            placeholder.style.display = 'block';
        }
    }

    // 재생/일시정지/다시보기 버튼 로직
    function togglePlayPause() {
        if (isFinished) {
            // 끝났으면 다시 보기
            playFromStart();
        } else {
            // 진행 중이면 일시정지/재생 토글
            isPaused = !isPaused;
            updatePlayButtonUI();
        }
    }

    function updatePlayButtonUI() {
        const btn = document.getElementById('playPauseBtn');
        if (isFinished) {
            btn.innerText = "다시 보기";
            btn.style.backgroundColor = "var(--success-color)";
            btn.style.color = "black";
        } else if (isPaused) {
            btn.innerText = "재생";
            btn.style.backgroundColor = "var(--success-color)";
            btn.style.color = "black";
        } else {
            btn.innerText = "일시정지";
            btn.style.backgroundColor = "var(--card-color)";
            btn.style.color = "var(--accent-color)";
        }
    }

    function resetUIForLoading(text) {
        document.getElementById('answerInput').value = "";
        document.getElementById('feedback').innerText = "";
        document.getElementById('mainImage').style.display = 'none';
        
        const placeholder = document.getElementById('placeholderText');
        placeholder.innerHTML = text;
        placeholder.classList.remove('large-text');
        placeholder.style.display = 'block';
        
        isFinished = false;
        isPaused = false;
        updatePlayButtonUI();
    }

    function checkAnswer() {
        let ansInput = document.getElementById('answerInput');
        let ans = ansInput.value.trim();
        if (!currentWord) return;
        
        let isCorrect = (ans === currentWord);
        let feedback = document.getElementById('feedback');
        
        feedback.innerText = isCorrect ? "정답입니다!" : `오답! 정답: ${currentWord}`;
        feedback.style.color = isCorrect ? "var(--success-color)" : "var(--danger-color)";
        
        if(isCorrect) ansInput.blur();
        
        historyData.push({ word: currentWord, status: isCorrect ? "정답" : "오답" });
        localStorage.setItem('fingerspell_history', JSON.stringify(historyData));
    }

    // --- 뷰 전환 및 기록 관련 기능 ---
    function showHistoryView() {
        document.getElementById('mainView').classList.remove('active');
        document.getElementById('historyView').classList.add('active');
        renderHistoryList();
    }

    function hideHistoryView() {
        document.getElementById('historyView').classList.remove('active');
        document.getElementById('mainView').classList.add('active');
    }

    function renderHistoryList() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        if (historyData.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#8E8E93; padding: 20px;">기록이 없습니다.</li>';
            return;
        }

        // 최신순으로 정렬하여 표시
        [...historyData].reverse().forEach(item => {
            const li = document.createElement('li');
            li.className = 'history-item';
            
            // 기록 클릭 시 해당 단어로 바로 재생하는 이벤트 추가
            li.onclick = () => playWordFromHistory(item.word);
            
            const statusClass = item.status === '정답' ? 'status-correct' : 'status-wrong';
            li.innerHTML = `
                <span class="history-word">${item.word} <span style="font-size: 12px; font-weight: normal; color: #8E8E93;">(클릭하여 재생)</span></span>
                <span class="history-status ${statusClass}">${item.status}</span>
            `;
            list.appendChild(li);
        });
    }

    // 기록에서 특정 단어를 클릭했을 때 실행되는 함수
    async function playWordFromHistory(word) {
        hideHistoryView(); // 메인 화면으로 돌아가기
        if(timer) clearInterval(timer);
        resetUIForLoading("이미지<br>불러오는 중...");
        
        currentWord = word;
        jamoList = splitHangul(currentWord);
        
        cachedFrames = await preloadAllImages(jamoList);
        playFromStart();
    }
</script>
</body>
</html>

