<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="지문자 마스터">
    <link rel="apple-touch-icon" href="icon.png"> <title>지문자 마스터</title>
    <style>
        :root {
            --bg-color: #1E1E1E;
            --card-color: #2D2D30;
            --text-color: #D4D4D4;
            --accent-color: #0A84FF; /* iOS Blue */
        }
        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; overflow: hidden;
            box-sizing: border-box;
        }
        .container {
            width: 100%; max-width: 400px;
            display: flex; flex-direction: column; gap: 15px;
        }
        .control-group {
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }
        input[type="range"] { flex-grow: 1; }
        .btn-group {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
        }
        button {
            background-color: var(--card-color); color: var(--text-color);
            border: 1px solid #3E3E42; border-radius: 10px; padding: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            transition: background-color 0.2s;
        }
        button.primary { background-color: var(--accent-color); color: white; border: none; }
        button:active { opacity: 0.7; }
        
        .card {
            background-color: var(--card-color); border-radius: 15px;
            border: 1px solid #3E3E42; padding: 20px;
            display: flex; flex-direction: column; align-items: center; gap: 15px;
        }
        .image-display {
            width: 200px; height: 200px;
            display: flex; justify-content: center; align-items: center;
            font-size: 50px; font-weight: bold;
            background-color: #1E1E1E; border-radius: 10px; overflow: hidden;
            text-align: center; word-break: keep-all;
        }
        .image-display img { width: 100%; height: 100%; object-fit: contain; }
        
        .input-group { display: flex; width: 100%; gap: 10px; }
        input[type="text"] {
            flex-grow: 1; padding: 12px; border-radius: 8px;
            border: 2px solid #3E3E42; background-color: var(--bg-color); color: white;
            font-size: 16px;
        }
        input[type="text"]:focus { border-color: var(--accent-color); outline: none; }
        #feedback { font-size: 18px; font-weight: bold; height: 24px; }
    </style>
</head>
<body>

<div class="container">
    <div class="control-group">
        <label>속도:</label>
        <input type="range" id="speedSlider" min="200" max="2000" value="500">
        <span id="speedVal">500ms</span>
    </div>

    <div class="btn-group">
        <button class="primary" onclick="startNewWord()">새로운 단어</button>
        <button onclick="replayWord()">다시 보기</button>
        <button id="pauseBtn" onclick="togglePause()">일시정지</button>
        <button onclick="showHistory()">기록 보기</button>
    </div>

    <div class="card">
        <div class="image-display" id="imageDisplay">대기 중</div>
        
        <div class="input-group">
            <input type="text" id="answerInput" placeholder="정답을 입력하세요">
            <button class="primary" onclick="checkAnswer()">확인</button>
        </div>
        <div id="feedback"></div>
    </div>
</div>

<script>
    let currentWord = "";
    let jamoList = [];
    let currentIdx = 0;
    let timer = null;
    let isPaused = false;
    let historyData = JSON.parse(localStorage.getItem('fingerspell_history')) || [];

    const CHOSUNG = ['ㄱ', 'ㄲ', 'ㄴ', 'ㄷ', 'ㄸ', 'ㄹ', 'ㅁ', 'ㅂ', 'ㅃ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅉ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
    const JUNGSUNG = ['ㅏ', 'ㅐ', 'ㅑ', 'ㅒ', 'ㅓ', 'ㅔ', 'ㅕ', 'ㅖ', 'ㅗ', 'ㅘ', 'ㅙ', 'ㅚ', 'ㅛ', 'ㅜ', 'ㅝ', 'ㅞ', 'ㅟ', 'ㅠ', 'ㅡ', 'ㅢ', 'ㅣ'];
    const JONGSUNG = ['', 'ㄱ', 'ㄲ', 'ㄳ', 'ㄴ', 'ㄵ', 'ㄶ', 'ㄷ', 'ㄹ', 'ㄺ', 'ㄻ', 'ㄼ', 'ㄽ', 'ㄾ', 'ㄿ', 'ㅀ', 'ㅁ', 'ㅂ', 'ㅄ', 'ㅅ', 'ㅆ', 'ㅇ', 'ㅈ', 'ㅊ', 'ㅋ', 'ㅌ', 'ㅍ', 'ㅎ'];
    const COMPOUND = {'ㄳ':['ㄱ','ㅅ'], 'ㄵ':['ㄴ','ㅈ'], 'ㄶ':['ㄴ','ㅎ'], 'ㄺ':['ㄹ','ㄱ'], 'ㄻ':['ㄹ','ㅁ'], 'ㄼ':['ㄹ','ㅂ'], 'ㄽ':['ㄹ','ㅅ'], 'ㄾ':['ㄹ','ㅌ'], 'ㄿ':['ㄹ','ㅍ'], 'ㅀ':['ㄹ','ㅎ'], 'ㅄ':['ㅂ','ㅅ'], 'ㅘ':['ㅗ','ㅏ'], 'ㅙ':['ㅗ','ㅐ'], 'ㅝ':['ㅜ','ㅓ'], 'ㅞ':['ㅜ','ㅔ'], 'ㄲ':['ㄱ','ㄱ (2)'], 'ㄸ':['ㄷ','ㄷ (2)'], 'ㅃ':['ㅂ','ㅂ (2)'], 'ㅆ':['ㅅ','ㅅ (2)'], 'ㅉ':['ㅈ','ㅈ (2)']};

    function splitHangul(word) {
        let result = [];
        for (let i = 0; i < word.length; i++) {
            let code = word.charCodeAt(i) - 44032;
            if (code >= 0 && code <= 11171) {
                let cho = Math.floor(code / 588);
                let jung = Math.floor((code % 588) / 28);
                let jong = code % 28;
                
                [CHOSUNG[cho], JUNGSUNG[jung], JONGSUNG[jong]].forEach(unit => {
                    if (unit) {
                        if (COMPOUND[unit]) result.push(...COMPOUND[unit]);
                        else result.push(unit);
                    }
                });
            }
        }
        return result;
    }

    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    speedSlider.addEventListener('input', (e) => speedVal.innerText = e.target.value + 'ms');

    document.getElementById('answerInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') checkAnswer();
    });

    // 방금 수정한 국립국어원 API 연동 함수입니다.
    // index.html 내의 fetchWord 함수 교체
    async function fetchWord() {
        try {
            const response = await fetch('/api/word');
            
            // 내 Vercel 서버에서 에러를 뿜으면 그 원인을 읽어옵니다.
            if (!response.ok) {
                const errorJson = await response.json();
                throw new Error(`Vercel 서버 에러: ${errorJson.error}`);
            }
            
            const textData = await response.text();
            
            // 국립국어원 자체 에러 (예: 키 오류, 권한 없음 등)
            if (textData.includes("<error>")) {
                console.error("국립국어원 에러 원문:", textData);
                throw new Error("국립국어원 API 자체 에러 (한도초과 또는 설정 오류)");
            }

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(textData, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");

            if (items.length > 0) {
                const randomIndex = Math.floor(Math.random() * items.length);
                let word = items[randomIndex].getElementsByTagName("word")[0].textContent;
                word = word.replace(/[^가-힣]/g, ''); 
                if (word) return word;
            }
            
            throw new Error("사전에서 조건에 맞는 단어를 찾지 못했습니다.");

        } catch (error) {
            // 원인을 정확히 파악하기 위해 경고창을 띄웁니다.
            alert("❌ API 통신 실패 원인:\n" + error.message);
            return "기찻길"; 
        }
    }

    async function startNewWord() {
        clearInterval(timer);
        const display = document.getElementById('imageDisplay');
        display.innerHTML = "API<br>불러오는 중...";
        display.style.fontSize = "24px"; 
        
        document.getElementById('answerInput').value = "";
        document.getElementById('feedback').innerText = "";
        document.getElementById('pauseBtn').innerText = "일시정지";
        
        currentWord = await fetchWord();
        
        display.style.fontSize = "50px"; 
        jamoList = splitHangul(currentWord);
        currentIdx = 0;
        isPaused = false;
        
        showNextImage();
    }

    function showNextImage() {
        if (isPaused) return;

        const display = document.getElementById('imageDisplay');
        if (currentIdx < jamoList.length) {
            let char = jamoList[currentIdx];
            
            // [중요] 실제 수어 이미지를 띄우려면 아래 코드의 주석을 풀고, 기존 display.innerText = char; 를 지우세요.
            // display.innerHTML = `<img src="images/${char}.png" alt="${char}" onerror="this.style.display='none'; this.parentElement.innerText='[${char}]'">`;
            
            display.innerText = char; 
            
            currentIdx++;
            timer = setTimeout(showNextImage, speedSlider.value);
        } else {
            display.innerHTML = "입력<br>대기 중";
            display.style.fontSize = "30px";
        }
    }

    function togglePause() {
        isPaused = !isPaused;
        document.getElementById('pauseBtn').innerText = isPaused ? "재생" : "일시정지";
        if (!isPaused) showNextImage();
        else clearTimeout(timer);
    }

    function replayWord() {
        if (currentWord) {
            currentIdx = 0;
            clearTimeout(timer);
            document.getElementById('imageDisplay').style.fontSize = "50px";
            showNextImage();
        }
    }

    function checkAnswer() {
        let ans = document.getElementById('answerInput').value.trim();
        if (!currentWord) return;
        
        let isCorrect = (ans === currentWord);
        let feedback = document.getElementById('feedback');
        
        feedback.innerText = isCorrect ? "정답입니다!" : `오답! 정답: ${currentWord}`;
        feedback.style.color = isCorrect ? "#4CAF50" : "#FF5252";
        
        historyData.push({ word: currentWord, status: isCorrect ? "정답" : "오답" });
        localStorage.setItem('fingerspell_history', JSON.stringify(historyData));
    }

    function showHistory() {
        let historyStr = historyData.map(item => `[${item.status}] ${item.word}`).reverse().join('\n');
        alert("학습 기록:\n\n" + (historyStr || "기록이 없습니다."));
    }
</script>
</body>

</html>
