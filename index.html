<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ì§€ë¬¸ì ë§ˆìŠ¤í„° í€˜ìŠ¤íŠ¸</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/aa.png">
    <style>
        :root {
            --bg-color: #000000;
            --card-color: #1C1C1E;
            --text-color: #E5E5E7;
            --accent-color: #0A84FF;
            --danger-color: #FF453A;
            --success-color: #32D74B;
            --warning-color: #FFD60A;
        }
        body {
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0; padding: env(safe-area-inset-top) 15px 20px 15px;
            height: 100dvh; overflow: hidden; box-sizing: border-box;
            position: relative;
        }
        
        .view { display: none; width: 100%; height: 100%; flex-direction: column; gap: 10px; }
        .view.active { display: flex; }

        /* --- ê²Œì„ ëŒ€ì‹œë³´ë“œ (ìƒë‹¨) --- */
        .game-dashboard {
            display: flex; justify-content: space-between; gap: 10px;
        }
        .stat-box {
            flex: 1; background-color: var(--card-color); padding: 12px 10px;
            border-radius: 12px; text-align: center; border: 1px solid #3E3E42;
            display: flex; flex-direction: column; gap: 4px;
        }
        .stat-title { font-size: 12px; color: #8E8E93; font-weight: bold; }
        .stat-value { font-size: 18px; font-weight: 800; color: white; }
        .level-text { color: var(--warning-color); }

        /* ë²„íŠ¼ ê·¸ë£¹ (3ê°œ -> 2ê°œë¡œ ë³€ê²½) */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        button {
            background-color: var(--card-color); color: var(--accent-color);
            border: none; border-radius: 10px; padding: 12px 5px;
            font-size: 15px; font-weight: bold; cursor: pointer; text-align: center;
        }
        button.primary { background-color: var(--accent-color); color: white; }
        button:active { opacity: 0.7; }
        
        /* ë©”ì¸ ì¹´ë“œ */
        .card {
            background-color: var(--card-color); border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            flex-grow: 1; justify-content: space-between; overflow: hidden;
        }
        
        /* í„°ì¹˜ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ì˜ì—­ (ì‹œê°ì  í”¼ë“œë°± ì¶”ê°€) */
        .image-wrapper {
            width: 100%; flex-grow: 1; display: flex; justify-content: center; align-items: center;
            background-color: #000; border-radius: 12px; overflow: hidden; position: relative;
            cursor: pointer; transition: transform 0.1s;
        }
        .image-wrapper:active { transform: scale(0.98); } /* ëˆ„ë¥¼ ë•Œ ì‚´ì§ ë“¤ì–´ê°€ëŠ” íš¨ê³¼ */
        
        #mainImage { width: 100%; height: 100%; object-fit: contain; display: none; }
        #placeholderText { position: absolute; width: 100%; text-align: center; font-size: 24px; color: #8E8E93; font-weight: bold; }
        .large-text { font-size: 120px !important; color: white !important; }

        .input-group { display: flex; width: 100%; gap: 8px; margin-top: auto; }
        input[type="text"] {
            flex-grow: 1; padding: 12px; border-radius: 10px; border: none;
            background-color: #2C2C2E; color: white; font-size: 17px;
        }
        input[type="text"]:focus { outline: 2px solid var(--accent-color); }
        #feedback { font-size: 17px; font-weight: bold; height: 24px; text-align: center; }

        /* --- ê²Œì„ ì˜¤ë²„ / ë ˆë²¨ì—… ëª¨ë‹¬ --- */
        #gameModal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center; padding: 20px; box-sizing: border-box;
        }
        #modalTitle { font-size: 40px; font-weight: 900; margin-bottom: 10px; }
        #modalDesc { font-size: 18px; color: #D4D4D4; margin-bottom: 30px; line-height: 1.5; }
        #modalBtn {
            background-color: white; color: black; padding: 15px 40px;
            font-size: 18px; border-radius: 30px; border: none; font-weight: bold;
        }

        /* ê¸°ë¡ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .history-header { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px solid #3E3E42; }
        .history-header button { background: none; border: none; color: var(--accent-color); font-size: 16px; padding: 5px 15px 5px 0; }
        .history-header h2 { margin: 0; flex-grow: 1; text-align: center; font-size: 18px; padding-right: 40px; }
        .history-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .history-item { background-color: var(--card-color); margin-bottom: 8px; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .history-word { font-size: 18px; font-weight: bold; }
        .history-status { font-size: 14px; font-weight: bold; padding: 4px 8px; border-radius: 6px; }
        .status-correct { background-color: rgba(50, 215, 75, 0.2); color: var(--success-color); }
        .status-wrong { background-color: rgba(255, 69, 58, 0.2); color: var(--danger-color); }
    </style>
</head>
<body>

<div id="gameModal">
    <div id="modalTitle">GAME OVER</div>
    <div id="modalDesc">ì˜¤ë‹µì…ë‹ˆë‹¤!<br>ë ˆë²¨ 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘í•©ë‹ˆë‹¤.</div>
    <button id="modalBtn" onclick="closeModalAndStart()">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
</div>

<div id="mainView" class="view active">
    
    <div class="game-dashboard">
        <div class="stat-box">
            <span class="stat-title">í˜„ì¬ ìŠ¤í…Œì´ì§€</span>
            <span class="stat-value level-text" id="uiLevel">Level 1</span>
        </div>
        <div class="stat-box">
            <span class="stat-title">ì—°ì† ì •ë‹µ (ìŠ¹ê¸‰ì¡°ê±´)</span>
            <span class="stat-value" id="uiCombo">0 / 3</span>
        </div>
    </div>

    <div class="btn-group">
        <button id="playPauseBtn" onclick="togglePlayPause()">ì¼ì‹œì •ì§€</button>
        <button onclick="showHistoryView()">ê¸°ë¡ ë³´ê¸°</button>
    </div>

    <div class="card">
        <div class="image-wrapper" id="imageWrapper" onclick="handleImageClick()">
            <img id="mainImage" alt="ìˆ˜ì–´ ì´ë¯¸ì§€">
            <span id="placeholderText">í™”ë©´ì„ í„°ì¹˜í•˜ì—¬<br>ì‹œì‘í•˜ì„¸ìš” ğŸ‘†</span>
        </div>
        
        <div id="feedback"></div>

        <div class="input-group">
            <input type="text" id="answerInput" placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off" enterkeyhint="done">
            <button class="primary" onclick="checkAnswer()" style="padding: 0 20px;">í™•ì¸</button>
        </div>
    </div>
</div>

<div id="historyView" class="view">
    <div class="history-header">
        <button onclick="hideHistoryView()">â® ë’¤ë¡œ</button>
        <h2>í•™ìŠµ ê¸°ë¡</h2>
    </div>
    <ul class="history-list" id="historyList"></ul>
</div>

<script>
    const levels = [
        { level: 1, speed: 1000, length: '2-3', req: 3 }, 
        { level: 2, speed: 800,  length: '2-3', req: 3 }, 
        { level: 3, speed: 800,  length: '3-4', req: 3 }, 
        { level: 4, speed: 600,  length: '3-4', req: 4 }, 
        { level: 5, speed: 450,  length: '3-4', req: 4 }, 
        { level: 6, speed: 500,  length: '5+',  req: 4 }, 
        { level: 7, speed: 300,  length: '5+',  req: 5 }  
    ];

    let currentLevelIdx = 0;
    let combo = 0;
    
    let currentWord = "";
    let jamoList = [];
    let cachedFrames = []; 
    let currentIdx = 0;
    let timer = null;
    let isPaused = false;
    let isFinished = false; 
    let isAnsweredCorrectly = false; // ì •ë‹µ ì—¬ë¶€ ì²´í¬ ë³€ìˆ˜
    let historyData = JSON.parse(localStorage.getItem('fingerspell_history')) || [];

    const fallbackWords = {
        '2-3': ["ì‚¬ê³¼","í¬ë„","í•™êµ","ë°”ë‹¤","í•˜ëŠ˜","ìš°ì£¼","ì˜ì","ì—°í•„","ê°€ë°©","ì‹ ë°œ","ì‚¬ì§„","êµ¬ë¦„","ê°€ì¡±","ì¹œêµ¬","ì‚¬ë‘","ìš´ë™","ìˆ˜ì˜","ê¸°ì°¨","ë²„ìŠ¤","ê²½ì°°","ë³‘ì›","ì‹ë‹¹","ë™ë¬¼","í”¼ì•„ë…¸"],
        '3-4': ["ì»´í“¨í„°","ìì „ê±°","ë„ì„œê´€","ë°•ë¬¼ê´€","ê²½ì°°ì„œ","ì†Œë°©ì„œ","ì„ ìƒë‹˜","ì¹´ë©”ë¼","ëƒ‰ì¥ê³ ","ì„¸íƒê¸°","ìë™ì°¨","ì§€í•˜ì² ","ì‹ í˜¸ë“±","ë†€ì´í„°","ìš°ì²´êµ­","í¸ì˜ì ","ëŒ€í•™êµ","ìš´ë™ì¥","ìˆ˜ì˜ì¥","ë¯¸ìˆ ê´€"],
        '5+': ["ëŒ€í•œë¯¼êµ­","ì•„ì´ìŠ¤í¬ë¦¼","í…”ë ˆë¹„ì „","ì—˜ë¦¬ë² ì´í„°","ì—ìŠ¤ì»¬ë ˆì´í„°","ìŠ¤ë§ˆíŠ¸í°","ë™ë¬¼ì›","ì‹ë¬¼ì›","ê³¼í•™ê´€","ì£¼ë¯¼ì„¼í„°","ë³´ê±´ì†Œ"]
    };

    const CHOSUNG = ['ã„±','ã„²','ã„´','ã„·','ã„¸','ã„¹','ã…','ã…‚','ã…ƒ','ã……','ã…†','ã…‡','ã…ˆ','ã…‰','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
    const JUNGSUNG = ['ã…','ã…','ã…‘','ã…’','ã…“','ã…”','ã…•','ã…–','ã…—','ã…˜','ã…™','ã…š','ã…›','ã…œ','ã…','ã…','ã…Ÿ','ã… ','ã…¡','ã…¢','ã…£'];
    const JONGSUNG = ['','ã„±','ã„²','ã„³','ã„´','ã„µ','ã„¶','ã„·','ã„¹','ã„º','ã„»','ã„¼','ã„½','ã„¾','ã„¿','ã…€','ã…','ã…‚','ã…„','ã……','ã…†','ã…‡','ã…ˆ','ã…Š','ã…‹','ã…Œ','ã…','ã…'];
    const COMPOUND = {
        'ã„³':['ã„±','ã……'], 'ã„µ':['ã„´','ã…ˆ'], 'ã„¶':['ã„´','ã…'], 'ã„º':['ã„¹','ã„±'], 'ã„»':['ã„¹','ã…'], 
        'ã„¼':['ã„¹','ã…‚'], 'ã„½':['ã„¹','ã……'], 'ã„¾':['ã„¹','ã…Œ'], 'ã„¿':['ã„¹','ã…'], 'ã…€':['ã„¹','ã…'], 
        'ã…„':['ã…‚','ã……'], 'ã…˜':['ã…—','ã…'], 'ã…™':['ã…—','ã…'], 'ã…':['ã…œ','ã…“'], 'ã…':['ã…œ','ã…”'], 
        'ã„²':['ã„±','ã„± (2)'], 'ã„¸':['ã„·','ã„· (2)'], 'ã…ƒ':['ã…‚','ã…‚ (2)'], 'ã…†':['ã……','ã…… (2)'], 'ã…‰':['ã…ˆ','ã…ˆ (2)']
    };

    function splitHangul(word) {
        let result = [];
        for (let i = 0; i < word.length; i++) {
            let code = word.charCodeAt(i) - 44032;
            if (code >= 0 && code <= 11171) {
                let cho = Math.floor(code / 588);
                let jung = Math.floor((code % 588) / 28);
                let jong = code % 28;
                [CHOSUNG[cho], JUNGSUNG[jung], JONGSUNG[jong]].forEach(unit => {
                    if (unit) {
                        if (COMPOUND[unit]) result.push(...COMPOUND[unit]);
                        else result.push(unit);
                    }
                });
            }
        }
        return result;
    }

    function updateGameUI() {
        const lvData = levels[currentLevelIdx];
        document.getElementById('uiLevel').innerText = `Level ${lvData.level}`;
        document.getElementById('uiCombo').innerText = `${combo} / ${lvData.req}`;
    }

    document.getElementById('answerInput').addEventListener('keypress', (e) => { if(e.key==='Enter') checkAnswer(); });

    // --- í™”ë©´ í„°ì¹˜ ì»¨íŠ¸ë¡¤ ë¡œì§ ---
    function handleImageClick() {
        // 1. ì•„ì§ ê²Œì„ì„ ì‹œì‘í•˜ì§€ ì•Šì€ ì´ˆê¸° ìƒíƒœë©´ ë°”ë¡œ ì‹œì‘
        if (currentWord === "") {
            startNewWord();
            return;
        }
        
        // 2. ì •ë‹µì„ ë§íŒ ìƒíƒœë¼ë©´ ì–¸ì œë“  í„°ì¹˜í•´ì„œ ë‹¤ìŒ ë¬¸ì œë¡œ ë„˜ì–´ê°
        if (isAnsweredCorrectly) {
            startNewWord();
            return;
        }
        
        // 3. ì •ë‹µì„ ì•„ì§ ëª» ë§ì·„ëŠ”ë° ì¬ìƒì´ ëë‚¬ë‹¤ë©´, ê±´ë„ˆë›°ê¸° í—ˆìš© (ëŒ€ì‹  ì½¤ë³´ëŠ” ì´ˆê¸°í™”)
        if (isFinished) {
            combo = 0; 
            updateGameUI();
            startNewWord();
        }
    }

    async function fetchWord() {
        const selectedRange = levels[currentLevelIdx].length;
        let targetList = fallbackWords[selectedRange]; 

        try {
            const response = await fetch('/api/word');
            if (!response.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
            const textData = await response.text();
            if (textData.includes("<error>")) throw new Error("API ì˜¤ë¥˜");

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(textData, "text/xml");
            const items = Array.from(xmlDoc.getElementsByTagName("item"));

            let candidates = items.map(item => item.getElementsByTagName("word")[0].textContent.replace(/[^ê°€-í£]/g, ''));
            if (selectedRange === '2-3') candidates = candidates.filter(w => w.length >= 2 && w.length <= 3);
            else if (selectedRange === '3-4') candidates = candidates.filter(w => w.length >= 3 && w.length <= 4);
            else if (selectedRange === '5+') candidates = candidates.filter(w => w.length >= 5);

            if (candidates.length > 0) return candidates[Math.floor(Math.random() * candidates.length)];
            throw new Error("ì¡°ê±´ì— ë§ëŠ” ë‹¨ì–´ ì—†ìŒ");
        } catch (error) {
            return targetList[Math.floor(Math.random() * targetList.length)];
        }
    }

    function preloadAllImages(jamoArray) {
        return Promise.all(jamoArray.map(char => {
            return new Promise(resolve => {
                const img = new Image();
                img.src = `images/${char}.png`;
                img.onload = () => resolve({ type: 'image', src: img.src, char: char });
                img.onerror = () => resolve({ type: 'text', char: char });
            });
        }));
    }

    async function startNewWord() {
        if(timer) clearInterval(timer);
        resetUIForLoading("ë‹¨ì–´ ì°¾ëŠ” ì¤‘...");
        updateGameUI();
        
        currentWord = await fetchWord();
        jamoList = splitHangul(currentWord);
        
        document.getElementById('placeholderText').innerHTML = "ì´ë¯¸ì§€<br>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
        
        cachedFrames = await preloadAllImages(jamoList);
        playFromStart();
    }

    function playFromStart() {
        if(timer) clearInterval(timer);
        currentIdx = 0;
        isPaused = false;
        isFinished = false;
        isAnsweredCorrectly = false; // ì •ë‹µ ì—¬ë¶€ ì´ˆê¸°í™”
        
        updatePlayButtonUI();
        renderFrame();
        
        const currentSpeed = levels[currentLevelIdx].speed;
        timer = setInterval(renderFrame, currentSpeed);
    }

    function renderFrame() {
        if (isPaused || isFinished) return;

        const mainImage = document.getElementById('mainImage');
        const placeholder = document.getElementById('placeholderText');

        if (currentIdx < cachedFrames.length) {
            const frame = cachedFrames[currentIdx];
            if (frame.type === 'image') {
                mainImage.src = frame.src;
                mainImage.style.display = 'block';
                placeholder.style.display = 'none';
            } else {
                mainImage.style.display = 'none';
                placeholder.innerText = frame.char;
                placeholder.classList.add('large-text');
                placeholder.style.display = 'block';
            }
            currentIdx++;
        } else {
            clearInterval(timer);
            isFinished = true;
            updatePlayButtonUI();
            
            // ì¬ìƒì´ ëë‚¬ì„ ë•Œ í™”ë©´ì— í„°ì¹˜ ì•ˆë‚´ ì¶”ê°€
            mainImage.style.display = 'none';
            placeholder.innerHTML = "ì…ë ¥ ëŒ€ê¸° ì¤‘<br><span style='font-size:14px; font-weight:normal; margin-top:15px; display:block;'>í™”ë©´ í„°ì¹˜ ì‹œ ë‹¤ìŒìœ¼ë¡œ ê±´ë„ˆëœë‹ˆë‹¤ (ì½¤ë³´ ì´ˆê¸°í™”)</span>";
            placeholder.classList.remove('large-text');
            placeholder.style.display = 'block';
        }
    }

    function togglePlayPause() {
        if (isFinished) playFromStart();
        else {
            isPaused = !isPaused;
            updatePlayButtonUI();
        }
    }

    function updatePlayButtonUI() {
        const btn = document.getElementById('playPauseBtn');
        if (isFinished) {
            btn.innerText = "ë‹¤ì‹œ ë³´ê¸°";
            btn.style.backgroundColor = "var(--success-color)";
            btn.style.color = "black";
        } else if (isPaused) {
            btn.innerText = "ì¬ìƒ";
            btn.style.backgroundColor = "var(--success-color)";
            btn.style.color = "black";
        } else {
            btn.innerText = "ì¼ì‹œì •ì§€";
            btn.style.backgroundColor = "var(--card-color)";
            btn.style.color = "var(--accent-color)";
        }
    }

    function resetUIForLoading(text) {
        document.getElementById('answerInput').value = "";
        document.getElementById('feedback').innerText = "";
        document.getElementById('mainImage').style.display = 'none';
        
        const placeholder = document.getElementById('placeholderText');
        placeholder.innerHTML = text;
        placeholder.classList.remove('large-text');
        placeholder.style.display = 'block';
        
        isFinished = false;
        isPaused = false;
        updatePlayButtonUI();
    }

    function checkAnswer() {
        let ansInput = document.getElementById('answerInput');
        let ans = ansInput.value.trim();
        if (!currentWord || isAnsweredCorrectly) return; // ì´ë¯¸ ì •ë‹µ ë§ì¶˜ ìƒíƒœë©´ ë¬´ì‹œ
        
        let isCorrect = (ans === currentWord);
        let feedback = document.getElementById('feedback');
        
        historyData.push({ word: currentWord, status: isCorrect ? "ì •ë‹µ" : "ì˜¤ë‹µ" });
        localStorage.setItem('fingerspell_history', JSON.stringify(historyData));

        if (isCorrect) {
            ansInput.blur();
            isAnsweredCorrectly = true;
            
            // ì¬ìƒ ì¤‘ì´ì—ˆë‹¤ë©´ ì˜ìƒ ì¦‰ì‹œ ì •ì§€
            clearInterval(timer);
            isFinished = true;
            updatePlayButtonUI();

            combo++;
            let req = levels[currentLevelIdx].req;
            
            if (combo >= req) {
                // ìŠ¹ê¸‰
                currentLevelIdx++;
                combo = 0;
                if (currentLevelIdx >= levels.length) {
                    showModal("ğŸ† ë§ˆìŠ¤í„° ë‹¬ì„±! ğŸ†", "ëª¨ë“  ë ˆë²¨ì„ ì •ë³µí–ˆìŠµë‹ˆë‹¤!<br>ë‹¹ì‹ ì€ ì§„ì •í•œ ì§€ë¬¸ì ë§ˆìŠ¤í„°ì…ë‹ˆë‹¤.", "ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°");
                    currentLevelIdx = 0; 
                } else {
                    let nextLv = levels[currentLevelIdx].level;
                    showModal(`ğŸ‰ LEVEL UP! ğŸ‰`, `ì¶•í•˜í•©ë‹ˆë‹¤!<br><b>[Level ${nextLv}]</b>ë¡œ ì§„ì…í•©ë‹ˆë‹¤.<br>ë‚œì´ë„ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.`, "í„°ì¹˜í•˜ì—¬ ë‹¤ìŒ ë ˆë²¨ ì‹œì‘");
                }
            } else {
                // ì¼ë°˜ ì •ë‹µ
                feedback.innerText = "ì •ë‹µì…ë‹ˆë‹¤!";
                feedback.style.color = "var(--success-color)";
                updateGameUI();
                
                // í™”ë©´ì— ì‹œì›í•˜ê²Œ í„°ì¹˜ ìœ ë„ ë©”ì‹œì§€ í‘œì‹œ
                document.getElementById('mainImage').style.display = 'none';
                document.getElementById('placeholderText').innerHTML = "ğŸ‰ ì •ë‹µ! ğŸ‰<br><span style='font-size:18px; color:var(--success-color); margin-top:15px; display:block;'>í™”ë©´ì„ í„°ì¹˜í•˜ì—¬ ë‹¤ìŒ ì§„í–‰ ğŸ‘†</span>";
                document.getElementById('placeholderText').classList.remove('large-text');
                document.getElementById('placeholderText').style.display = 'block';
            }
        } else {
            // ì˜¤ë‹µ -> ê²Œì„ ì˜¤ë²„
            ansInput.blur();
            let currentLv = levels[currentLevelIdx].level;
            currentLevelIdx = 0;
            combo = 0;
            updateGameUI();
            showModal("ğŸ’€ GAME OVER ğŸ’€", `ì˜¤ë‹µì…ë‹ˆë‹¤! ì •ë‹µì€ [<b>${currentWord}</b>] ì˜€ìŠµë‹ˆë‹¤.<br>ì•ˆíƒ€ê¹ê²Œë„ [Level ${currentLv}]ì—ì„œ íƒˆë½í–ˆìŠµë‹ˆë‹¤.`, "Level 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘");
        }
    }

    // ëª¨ë‹¬(íŒì—…) ì œì–´
    function showModal(title, desc, btnText) {
        document.getElementById('modalTitle').innerHTML = title;
        document.getElementById('modalDesc').innerHTML = desc;
        document.getElementById('modalBtn').innerText = btnText;
        document.getElementById('gameModal').style.display = 'flex';
        resetUIForLoading("í™”ë©´ì„ í„°ì¹˜í•˜ì—¬<br>ì‹œì‘í•˜ì„¸ìš” ğŸ‘†");
    }

    function closeModalAndStart() {
        document.getElementById('gameModal').style.display = 'none';
        updateGameUI();
        startNewWord(); // ë²„íŠ¼ ëˆ„ë¥´ë©´ ëª¨ë‹¬ ë‹«íˆë©° ì¦‰ì‹œ ìƒˆ ë‹¨ì–´ ì‹œì‘
    }

    function showHistoryView() {
        document.getElementById('mainView').classList.remove('active');
        document.getElementById('historyView').classList.add('active');
        renderHistoryList();
    }

    function hideHistoryView() {
        document.getElementById('historyView').classList.remove('active');
        document.getElementById('mainView').classList.add('active');
    }

    function renderHistoryList() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        
        if (historyData.length === 0) {
            list.innerHTML = '<li style="text-align:center; color:#8E8E93; padding: 20px;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            return;
        }

        [...historyData].reverse().forEach(item => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.onclick = () => playWordFromHistory(item.word);
            
            const statusClass = item.status === 'ì •ë‹µ' ? 'status-correct' : 'status-wrong';
            li.innerHTML = `
                <span class="history-word">${item.word} <span style="font-size: 12px; font-weight: normal; color: #8E8E93;">(í´ë¦­í•˜ì—¬ ì¬ìƒ)</span></span>
                <span class="history-status ${statusClass}">${item.status}</span>
            `;
            list.appendChild(li);
        });
    }

    async function playWordFromHistory(word) {
        hideHistoryView(); 
        if(timer) clearInterval(timer);
        resetUIForLoading("ì´ë¯¸ì§€<br>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        
        currentWord = word;
        jamoList = splitHangul(currentWord);
        cachedFrames = await preloadAllImages(jamoList);
        
        const replaySpeed = levels[0].speed;
        
        currentIdx = 0;
        isPaused = false;
        isFinished = false;
        isAnsweredCorrectly = false;
        updatePlayButtonUI();
        renderFrame();
        timer = setInterval(renderFrame, replaySpeed);
    }

    updateGameUI();
</script>
</body>
</html>
